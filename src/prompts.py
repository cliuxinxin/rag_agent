# src/prompts.py

def get_context_caching_system_prompt(content: str) -> str:
    return f"""ä½ æ˜¯ä¸€ä¸ªå¤„äº"DeepSeek Context Caching"æ¨¡å¼ä¸‹çš„é¡¶çº§ä¸“å®¶ã€‚
ä»¥ä¸‹æ˜¯æˆ‘ä»¬éœ€è¦æ·±åº¦å¤„ç†çš„æ–‡æ¡£å…¨æ–‡ï¼ˆå·²ç¼“å­˜ï¼‰ï¼Œè¯·ä»”ç»†é˜…è¯»æ¯ä¸€ä¸ªæ®µè½ï¼š

<DOCUMENT_START>
{content}
<DOCUMENT_END>
"""

# === æ·±åº¦é˜…è¯» (Deep Read) ===

def get_read_planner_prompt(loop: int, max_loops: int, history_text: str) -> str:
    return f"""
    å½“å‰åˆ†æè½®æ¬¡: {loop + 1}/{max_loops}
    
    ã€æˆ‘ä»¬å·²æœ‰çš„ç†è§£ï¼ˆå·²è§£å†³çš„é—®é¢˜ï¼‰ã€‘
    {history_text}
    
    ã€ä»»åŠ¡ç›®æ ‡ã€‘
    è¯·å…ˆå¿«é€Ÿé€šè¯»å…¨æ–‡ï¼Œåˆ¤æ–­æ–‡ç« ä½“è£ã€‚
    ç„¶åï¼Œæå‡ºä¸‹ä¸€ä¸ªæœ€å€¼å¾—æŒ–æ˜çš„**"æ·±åº¦é—®é¢˜"**ã€‚
    
    ã€è¾“å‡ºè¦æ±‚ã€‘
    - å¦‚æœä½ è§‰å¾—æ–‡ç« çš„æ ¸å¿ƒé€»è¾‘ã€å…³é”®å†³ç­–ã€æ·±å±‚å«ä¹‰éƒ½å·²ç»åˆ†æé€å½»äº†ï¼Œè¾“å‡º "TERMINATE"ã€‚
    - å¦åˆ™ï¼Œè¾“å‡º**ä¸€ä¸ª**å…·ä½“çš„ã€æœ‰æ·±åº¦çš„é—®é¢˜ã€‚
    """

def get_read_writer_prompt(doc_title: str, history_text: str) -> str:
    return f"""
    æˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹ã€Š{doc_title}ã€‹çš„æ·±åº¦é˜…è¯»ã€‚
    
    ã€æ·±åº¦æ€è€ƒç´ æï¼ˆQ&A è®°å½•ï¼‰ã€‘
    {history_text}
    
    ã€å†™ä½œä»»åŠ¡ã€‘
    è¯·æ ¹æ®æ–‡æ¡£ç±»å‹ï¼Œåˆ©ç”¨ä¸Šè¿°ç´ æï¼Œæ’°å†™ä¸€ä»½**æ·±åº¦å¯¼è¯»ä¸åˆ†ææŠ¥å‘Š**ã€‚
    è¯·è‡ªé€‚åº”é€‰æ‹©ç»“æ„ï¼ˆçºªå®æ•…äº‹ vs æŠ€æœ¯æ–‡æ¡£ï¼‰ã€‚
    æ ‡é¢˜è‡ªæ‹Ÿï¼Œå…·æœ‰å¸å¼•åŠ›ã€‚
    """

# === æ·±åº¦å†™ä½œ (Writing) ===

def get_writer_iteration_prompt(idx: int, title: str, report: str, desc: str, context: str) -> str:
    return f"""
    ä½ æ˜¯ä¸€ä½è¿½æ±‚å®Œç¾çš„ç§‘æŠ€ä¸“æ ä¸»ç¼–ã€‚
    æ­£åœ¨æ’°å†™æ–‡ç« çš„ç¬¬ {idx + 1} éƒ¨åˆ†ï¼Œç« èŠ‚æ ‡é¢˜ä¸ºï¼šã€{title}ã€‘ã€‚
    
    ã€æ ¸å¿ƒç´ æ (Fact Base)ã€‘
    {report}
    
    ã€æœ¬ç« å†™ä½œæŒ‡å¼•ã€‘
    {desc}
    
    ã€ä¸Šæ–‡è„‰ç»œ (Context)ã€‘
    {context[-4000:]} 
    
    ã€å†™ä½œè¦æ±‚ã€‘
    - ç¦æ­¢é‡å¤æ ‡é¢˜ï¼Œç›´æ¥å†™æ­£æ–‡ã€‚
    - è¯­æ°”ä¸“ä¸šã€å®¢è§‚ã€æœ‰æ·±åº¦ã€‚
    - å¼€å¤´å¿…é¡»è‡ªç„¶æ‰¿æ¥ä¸Šæ–‡è„‰ç»œã€‚
    """

# === æ·±åº¦é—®ç­” (Deep QA) ===

def get_qa_planner_prompt(loop: int, max_loops: int, user_goal: str, history_text: str) -> str:
    return f"""
    å½“å‰æ€è€ƒè½®æ¬¡: {loop + 1}/{max_loops}
    
    ã€ç”¨æˆ·æå‡ºçš„æ ¸å¿ƒé—®é¢˜ã€‘
    "{user_goal}"
    
    ã€æˆ‘ä»¬å·²ä»æ–‡ä¸­æŸ¥è¯çš„ä¿¡æ¯ã€‘
    {history_text}
    
    ã€ä»»åŠ¡ç›®æ ‡ã€‘
    ä½ çš„å”¯ä¸€ç›®æ ‡æ˜¯å®Œæ•´ã€å‡†ç¡®åœ°å›ç­”ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜ã€‚
    è¯·åˆ¤æ–­ï¼šåŸºäºã€å·²æŸ¥è¯çš„ä¿¡æ¯ã€‘ï¼Œæˆ‘ä»¬æ˜¯å¦å·²ç»èƒ½å®Œç¾å›ç­”è¿™ä¸ªé—®é¢˜ï¼Ÿ
    
    - å¦‚æœè¿˜ç¼ºä¿¡æ¯ï¼ˆä¾‹å¦‚ç”¨æˆ·é—®å¯¹æ¯”ï¼Œä½†æˆ‘ä»¬åªæŸ¥äº†Aæ–¹ï¼‰ï¼Œè¯·æå‡ºä¸‹ä¸€ä¸ª**å…·ä½“çš„å­é—®é¢˜**ã€‚
    - å¦‚æœç”¨æˆ·é—®çš„æ˜¯ç»†èŠ‚ï¼ˆå¦‚æ•°æ®ï¼‰ï¼Œè¯·é€šè¿‡å­é—®é¢˜åå¤ç¡®è®¤ä¸Šä¸‹æ–‡ã€‚
    
    ã€è¾“å‡ºè¦æ±‚ã€‘
    - å¦‚æœä¿¡æ¯å·²å……è¶³ï¼Œè¯·ç›´æ¥è¾“å‡º "TERMINATE"ã€‚
    - å¦åˆ™ï¼Œè¾“å‡ºä¸€ä¸ª**ä¸ºäº†å›ç­”æ ¸å¿ƒé—®é¢˜å¿…é¡»ææ¸…æ¥šçš„å­é—®é¢˜**ã€‚
    """

def get_qa_writer_prompt(doc_title: str, user_goal: str, history_text: str) -> str:
    return f"""
    æˆ‘ä»¬é’ˆå¯¹æ–‡æ¡£ã€Š{doc_title}ã€‹è¿›è¡Œäº†é’ˆå¯¹æ€§çš„æ·±åº¦è°ƒç ”ã€‚
    
    ã€ç”¨æˆ·æé—®ã€‘
    {user_goal}
    
    ã€è°ƒç ”è¿‡ç¨‹ä¸å‘ç°ã€‘
    {history_text}
    
    ã€ä»»åŠ¡ã€‘
    è¯·åŸºäºä¸Šè¿°è°ƒç ”å‘ç°ï¼Œæ’°å†™æœ€ç»ˆå›ç­”ã€‚
    
    ã€è¦æ±‚ã€‘
    1. **ç›´å‡»ç—›ç‚¹**ï¼šç¬¬ä¸€å¥è¯ç›´æ¥ç»™å‡ºæ ¸å¿ƒç»“è®ºã€‚
    2. **è¯æ®ç¡®å‡¿**ï¼šå¼•ç”¨æ–‡ä¸­çš„å…·ä½“æ®µè½æˆ–æ•°æ®æ¥æ”¯æŒä½ çš„è§‚ç‚¹ï¼ˆåŸºäºè°ƒç ”å‘ç°ï¼‰ã€‚
    3. **é€»è¾‘é—­ç¯**ï¼šå¦‚æœæ–‡ä¸­æ²¡æœ‰ç›´æ¥ç­”æ¡ˆï¼Œè¯·æ ¹æ®æ–‡ä¸­çš„çº¿ç´¢è¿›è¡Œåˆç†æ¨æ–­ï¼Œå¹¶æ³¨æ˜è¿™æ˜¯æ¨æ–­ã€‚
    4. ä¸è¦å†™æˆ"å¯¼è¯»"æˆ–"è¯»åæ„Ÿ"ï¼Œè¦å†™æˆä¸“ä¸šçš„"ç­”æ¡ˆ"ã€‚
    """


# =========================================================
# === DeepSeek Newsroom (Deep Writing 2.0) Prompts ===
# =========================================================


def get_newsroom_base_prompt(content: str, requirement: str, style: str = "", length: str = "") -> str:
    """
    æ ¸å¿ƒç¼“å­˜å—ã€‚
    """
    # æ„é€ æ›´å¼ºçš„ System Instruction
    style_instr = f"- **å†™ä½œé£æ ¼/è¯­è°ƒ**: {style}" if style else ""
    length_instr = f"- **é¢„ä¼°ç¯‡å¹…**: {length}" if length else ""

    return f"""
<DOCUMENT_CACHE_START>
{content}
<DOCUMENT_CACHE_END>

<USER_REQUIREMENT>
{requirement}
{style_instr}
{length_instr}
</USER_REQUIREMENT>

ä½ ç°åœ¨çš„èº«ä»½æ˜¯ã€DeepSeek æ–°é—»å·¥ä½œå®¤ã€‘çš„æˆå‘˜ã€‚
æ‰€æœ‰çš„å·¥ä½œå¿…é¡»ä¸¥æ ¼åŸºäº <DOCUMENT_CACHE> ä¸­çš„å†…å®¹ã€‚
è¯·æ—¶åˆ»ç‰¢è®°ç”¨æˆ·çš„ã€å†™ä½œé£æ ¼ã€‘å’Œã€ç¯‡å¹…è¦æ±‚ã€‘ã€‚
"""


def get_angle_generator_prompt(search_context: str = "") -> str:
    # æ„é€ ä¸Šä¸‹æ–‡æ’å…¥å†…å®¹
    context_block = ""
    if search_context:
        context_block = f"""
    ã€ğŸŒ äº’è”ç½‘èƒŒæ™¯è¶‹åŠ¿ (ä¾›å‚è€ƒ)ã€‘
    {search_context}
    """

    return f"""
    ã€ä»»åŠ¡ï¼šé€‰é¢˜ç­–åˆ’ã€‘
    ä½œä¸ºé¦–å¸­ç­–åˆ’ï¼Œè¯·åŸºäºæ–‡æ¡£å†…å®¹ã€ç”¨æˆ·éœ€æ±‚{context_block}ï¼Œæ„æ€ 3 ä¸ªæˆªç„¶ä¸åŒçš„å†™ä½œåˆ‡å…¥è§’åº¦ï¼ˆAngleï¼‰ã€‚
    
    1. **æ·±åº¦è§£æå‹**ï¼šä¾§é‡é€»è¾‘ã€åŸç†å’Œæ·±åº¦åˆ†æã€‚
    2. **æ•…äº‹å™è¿°å‹**ï¼šä¾§é‡äººç‰©ã€æ—¶é—´çº¿å’Œå†²çªç»†èŠ‚ã€‚
    3. **è§‚ç‚¹è¯„è®ºå‹**ï¼šä¾§é‡æç‚¼æ ¸å¿ƒè§‚ç‚¹ï¼Œè¿›è¡Œæ‰¹åˆ¤æˆ–èµèµã€‚
    
    è¯· output JSON æ ¼å¼ï¼š
    [
        {{"title": "...", "desc": "...", "reasoning": "..."}},
        ...
    ]
    """


def get_outline_architect_prompt(angle: str) -> str:
    return f"""
    ã€ä»»åŠ¡ï¼šå¤§çº²æ„å»ºã€‘
    ç”¨æˆ·é€‰å®šçš„åˆ‡å…¥è§’åº¦æ˜¯ï¼šã€{angle}ã€‘ã€‚
    ä½œä¸ºæ¶æ„å¸ˆï¼Œè¯·åˆ¶å®šä¸€ä»½è¯¦ç»†çš„**ç»“æ„åŒ–å¤§çº²**ã€‚
    
    è¦æ±‚ï¼š
    1. åŒ…å« 4-8 ä¸ªç« èŠ‚ã€‚
    2. æ¯ä¸€ç« å¿…é¡»æ˜ç¡® "ä¸»æ—¨ (Gist)" å’Œ "éœ€å¼•ç”¨çš„æ ¸å¿ƒäº‹å®/æ•°æ® (Key Facts)"ã€‚
    3. é€»è¾‘æµç•…ï¼Œç¬¦åˆé€‰å®šçš„åˆ‡å…¥è§’åº¦ã€‚
    
    è¯· output JSON æ ¼å¼ï¼š
    [
        {{"title": "...", "gist": "æœ¬æ®µæ ¸å¿ƒè®²...", "key_facts": "å¼•ç”¨æ–‡æ¡£ä¸­å…³äºxxxçš„æ•°æ®..."}},
        ...
    ]
    """


def get_internal_researcher_prompt(section_title: str, key_facts_needed: str, search_context: str = "") -> str:
    # æ„é€ å¤–éƒ¨è¯æ®å—
    external_block = ""
    if search_context:
        external_block = f"""
    ã€ğŸŒ å¤–éƒ¨ç½‘ç»œè¯æ® (External Evidence)ã€‘
    (æ³¨æ„ï¼šå¦‚æœæ–‡æ¡£å†…å®¹è¿‡æ—¶ï¼Œè¯·ä¼˜å…ˆå‚è€ƒä»¥ä¸‹æœ€æ–°ä¿¡æ¯ï¼Œå¹¶åœ¨ç¬”è®°ä¸­æ ‡è®°æ¥æºä¸º [WEB])
    {search_context}
    """

    return f"""
    ã€ä»»åŠ¡ï¼šå†…éƒ¨é‡‡ç¼–ã€‘
    æˆ‘ä»¬è¦å†™ç« èŠ‚ï¼šã€{section_title}ã€‘
    éœ€è¦ç”¨åˆ°çš„ç´ æçº¿ç´¢ï¼š{key_facts_needed}
    
    è¯·ä½œä¸ºâ€œå†…éƒ¨æ¢å‘˜â€ï¼Œç»¼åˆ <DOCUMENT_CACHE> {external_block} ä¸­çš„ä¿¡æ¯ã€‚
    æå–å‡ºæœ€ç²¾å‡†çš„åŸæ–‡å¼•ç”¨ã€æ•°æ®æˆ–æ¡ˆä¾‹ã€‚
    
    Output formatï¼š
    - **äº‹å® 1**: ... (æ¥æº: [DOC] æˆ– [WEB])
    - **äº‹å® 2**: ... (æ¥æº: [DOC] æˆ– [WEB])
    - **æ¨è®º**: ... (åŸºäºåŸæ–‡çš„åˆç†æ¨æ–­)
    """


def get_section_drafter_prompt(section_title: str, research_notes: str, prev_context: str) -> str:
    return f"""
    ã€ä»»åŠ¡ï¼šç« èŠ‚æ’°å†™ã€‘
    å½“å‰ç« èŠ‚ï¼šã€{section_title}ã€‘
    
    ã€é‡‡ç¼–æä¾›çš„æ ¸å®ç´ æã€‘
    {research_notes}
    
    ã€å‰æ–‡è„‰ç»œï¼ˆä¿æŒè¿è´¯æ€§ï¼‰ã€‘
    ...{prev_context[-1000:]}
    
    è¯·æ’°å†™æœ¬ç« æ­£æ–‡ã€‚
    è¦æ±‚ï¼š
    1. **Show, Don't Tell**ï¼šå¤šç”¨ç´ æä¸­çš„ç»†èŠ‚ï¼Œå°‘ç”¨ç©ºæ´çš„å½¢å®¹è¯ã€‚
    2. **é£æ ¼ç»Ÿä¸€**ï¼šä¿æŒä¸“ä¸šä¸”å¸å¼•äººçš„ç¬”è§¦ã€‚
    3. **ç¦æ­¢**ï¼šä¸è¦å†™â€œç»¼ä¸Šæ‰€è¿°â€ã€â€œæœ¬ç« å°†è®¨è®ºâ€ï¼Œç›´æ¥è¿›å…¥å†…å®¹ã€‚
    4. é•¿åº¦é€‚ä¸­ï¼ˆ300-600å­—ï¼‰ã€‚
    """


def get_editor_reviewer_prompt(full_draft: str) -> str:
    return f"""
    ã€ä»»åŠ¡ï¼šä¸»ç¼–å®¡é˜…ã€‘
    ä»¥ä¸‹æ˜¯å°ç¼–æäº¤çš„åˆç¨¿ï¼š
    
    <DRAFT_START>
    {full_draft}
    <DRAFT_END>
    
    ä½œä¸ºæ¯’èˆŒä¸»ç¼–ï¼Œè¯·æå‡ºä¿®æ”¹æ„è§ã€‚å…³æ³¨ï¼š
    1. **é€»è¾‘æ–­å±‚**ï¼šæ®µè½ä¹‹é—´æ˜¯å¦ç”Ÿç¡¬ï¼Ÿ
    2. **åºŸè¯è¿‡å¤š**ï¼šæ˜¯å¦æœ‰å¾ˆå¤šæ­£ç¡®çš„åºŸè¯ï¼Ÿ
    3. **è¯­æ°”**ï¼šæ˜¯å¦ç¬¦åˆç”¨æˆ·æœ€åˆçš„éœ€æ±‚ï¼Ÿ
    
    è¯· outputä¸€æ®µå…·ä½“çš„â€œå®¡é˜…æ„è§ï¼ˆCritique Notesï¼‰â€ï¼ŒæŒ‡å¯¼æ¶¦è‰²å¸ˆè¿›è¡Œä¿®æ”¹ã€‚ä¸è¦ç›´æ¥æ”¹å†™ï¼Œåªç»™æ„è§ã€‚
    """


def get_final_polisher_prompt(full_draft: str, critique_notes: str) -> str:
    return f"""
    ã€ä»»åŠ¡ï¼šæœ€ç»ˆæ¶¦è‰²ã€‘
    
    ã€åˆç¨¿ã€‘
    {full_draft}
    
    ã€ä¸»ç¼–æ„è§ã€‘
    {critique_notes}
    
    è¯·ä½œä¸ºé‡‘ç‰Œæ¶¦è‰²å¸ˆï¼Œæ ¹æ®æ„è§å¯¹åˆç¨¿è¿›è¡Œ**å…¨æ–‡é‡å†™æˆ–ç²¾ä¿®**ã€‚
    Outputæœ€ç»ˆæˆç¨¿ï¼ˆMarkdown formatï¼‰ã€‚æ ‡é¢˜è¦è¶³å¤Ÿå¸å¼•äººã€‚
    """


def get_outline_refiner_prompt(current_outline_str: str, feedback: str) -> str:
    return f"""
    ã€ä»»åŠ¡ï¼šå¤§çº²ä¿®è®¢ã€‘
    
    ã€å½“å‰å¤§çº²ã€‘
    {current_outline_str}
    
    ã€ç”¨æˆ·ä¿®æ”¹æ„è§ã€‘
    "{feedback}"
    
    è¯·ä½œä¸ºæ¶æ„å¸ˆï¼Œæ ¹æ®ç”¨æˆ·çš„æ„è§å¯¹å¤§çº²è¿›è¡Œè°ƒæ•´ã€‚
    
    è¦æ±‚ï¼š
    1. ä¸¥æ ¼éµå¾ªç”¨æˆ·çš„ä¿®æ”¹æŒ‡ä»¤ï¼ˆå¦‚åˆ é™¤æŸç« ã€å¢åŠ æŸç« ã€åˆå¹¶ç« èŠ‚ï¼‰ã€‚
    2. å¦‚æœç”¨æˆ·åªæ˜¯æ¨¡ç³Šå»ºè®®ï¼ˆå¦‚"å†æ·±å…¥ä¸€ç‚¹"ï¼‰ï¼Œè¯·æ™ºèƒ½ç»†åŒ–å­ç« èŠ‚ã€‚
    3. ä¿æŒ JSON æ ¼å¼è¾“å‡ºï¼Œç»“æ„ä¸ä¹‹å‰ä¸€è‡´ï¼š
    [
        {{"title": "...", "gist": "...", "key_facts": "..."}},
        ...
    ]
    """

# === PPT Generation ===

def get_ppt_planner_prompt(content: str, slides_count: int = 10) -> str:
    return f"""
<DOCUMENT_CACHE_START>
{content}
<DOCUMENT_CACHE_END>

ã€ä»»åŠ¡ã€‘
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ¼”ç¤ºæ–‡ç¨¿ç­–åˆ’å¸ˆã€‚è¯·åŸºäºä¸Šè¿°æ–‡æ¡£ï¼Œç­–åˆ’ä¸€ä»½çº¦ {slides_count} é¡µçš„ PPT å¤§çº²ã€‚
PPT çš„ç›®æ ‡æ˜¯æ¸…æ™°ã€æœ‰é€»è¾‘åœ°å‘å¬ä¼—æ±‡æŠ¥æ–‡æ¡£æ ¸å¿ƒå†…å®¹ã€‚

è¯·è¾“å‡º JSON æ ¼å¼ï¼ŒåŒ…å«ä¸€ä¸ªåˆ—è¡¨ `slides`ï¼Œæ¯ä¸€é¡¹åŒ…å«ï¼š
1. `id`: é¡µç 
2. `type`: é¡µé¢ç±»å‹ï¼Œåªèƒ½ä»ä»¥ä¸‹é€‰æ‹©ä¸€ä¸ª:
   - "cover" (å°é¢)
   - "section" (ç« èŠ‚é¡µ)
   - "content" (æ­£æ–‡é¡µ)
3. `title`: é¡µé¢æ ‡é¢˜
4. `key_points`: (ä»… content ç±»å‹éœ€è¦) ä¸€ä¸ªç®€çŸ­çš„è¦ç‚¹åˆ—è¡¨ã€‚

Output JSON format only.
"""

def get_ppt_writer_prompt(content: str, outline_str: str) -> str:
    return f"""
<DOCUMENT_CACHE_START>
{content}
<DOCUMENT_CACHE_END>

ã€ä»»åŠ¡ã€‘
ä½ æ˜¯ä¸€ä½ PPT æ’°ç¨¿äººã€‚æ ¹æ®ç­–åˆ’å¸ˆæä¾›çš„å¤§çº²ï¼Œä¸ºæ¯ä¸€é¡µå¡«å……è¯¦ç»†çš„æ¼”è®²å†…å®¹ã€‚

ã€å¤§çº²ã€‘
{outline_str}

ã€è¦æ±‚ã€‘
è¯·è¾“å‡ºå®Œæ•´çš„ JSON æ•°æ® (List of Objects)ï¼Œç»“æ„å¦‚ä¸‹ï¼š
[
    {{
        "type": "cover" | "section" | "content",
        "title": "é¡µé¢æ ‡é¢˜",
        "subtitle": "å‰¯æ ‡é¢˜ (ä»… cover éœ€è¦)",
        "bullets": ["è¦ç‚¹1", "è¦ç‚¹2"], (ä»… content éœ€è¦)
        "speaker_notes": "æ¼”è®²è€…å¤‡æ³¨ (é€å­—ç¨¿)"
    }},
    ...
]

ç¡®ä¿ JSON æ ¼å¼åˆæ³•ã€‚
"""