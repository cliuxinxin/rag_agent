name: Deploy to Oracle Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 执行远程部署
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}       # 对应你填的 Oracle 公网 IP
          username: ${{ secrets.USERNAME }}   # 对应 opc 或 ubuntu
          key: ${{ secrets.KEY }}         # 对应刚才 cat id_rsa 复制的内容
          script: |
            cd /home/${{ secrets.USERNAME }}/rag_agent || { echo "目录不存在"; exit 1; }
            
            # 1. 自动识别架构并下载 Docker Compose V2 (保持不变)
            ARCH=$(uname -m)
            if [ "$ARCH" = "aarch64" ]; then
              DOCKER_CONFIG_ARCH="aarch64"
            else
              DOCKER_CONFIG_ARCH="x86_64"
            fi
            
            if [ ! -f "./docker-compose-v2" ]; then
              curl -SL "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-$DOCKER_CONFIG_ARCH" -o ./docker-compose-v2
              chmod +x ./docker-compose-v2
            fi

            # 2. 强制同步代码
            git fetch --all
            git reset --hard origin/main

            # 3. 【新增：核心修复步】先停止并删除旧容器，清理命名冲突
            echo "清理旧容器..."
            ./docker-compose-v2 down --remove-orphans

            # 4. 执行构建与启动
            echo "开始执行容器构建与启动..."
            ./docker-compose-v2 up -d --build --force-recreate

            # 5. 清理垃圾镜像
            docker image prune -f